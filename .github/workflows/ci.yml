name: CI - Melo Project

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el código
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      # 2. Instalar PHP y extensiones
      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, pdo_mysql
          coverage: xdebug

      # 3. Instalar dependencias de PHP (Composer)
      - name: Instalar dependencias con Composer
        run: |
          composer install --no-progress --no-suggest --prefer-dist

      # 4. Ejecutar pruebas unitarias/integración
      - name: Ejecutar PHPUnit
        run: |
          if [ -f ./vendor/bin/phpunit ]; then
            ./vendor/bin/phpunit --coverage-text --colors=always
          else
            echo "No se encontró PHPUnit, revisa tu composer.json"
          fi

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      # 1. Instalar PHP y PHP_CodeSniffer
      - name: Instalar PHP_CodeSniffer
        run: |
          composer global require "squizlabs/php_codesniffer=*"
          echo "${HOME}/.composer/vendor/bin" >> $GITHUB_PATH

      - name: Ejecutar PHP_CodeSniffer
        run: phpcs --standard=PSR12 ./ --extensions=php

      # 2. Instalar Node y ESLint para JS
      - name: Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Instalar ESLint
        run: |
          npm install eslint --global

      - name: Ejecutar ESLint en archivos JS
        run: eslint "**/*.js" || true
